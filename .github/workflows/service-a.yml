name: service-a
on:
  push:
    branches:
    - main
    paths:
    - 'service-a/**'

env:
  ENVIRONMENT: dev
  IMAGE_REGISTRY: sekolahlinux/atikur
  APP_NAME: service-a
  AWS_DEFAULT_REGION: ap-southeast-1
  KUBENAMESPACE: backend
  KUBECLUSTER: sekolahlinux      
    
jobs:
  build_docker_image:
    name: build docker image
    runs-on: ubuntu-latest
    steps:
      - name: Get Short SHA
        id: short-sha
        run: |
          echo "SHORT_SHA=`echo ${GITHUB_SHA} | cut -c1-8`" >> $GITHUB_ENV
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: sekolahlinux
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v4
        with:
          file: service-a/Dockerfile
          push: true
          tags: sekolahlinux/atikur:service-a-${{env.SHORT_SHA}}

  deploy_k8s:
    name: deploy k8s
    runs-on: ubuntu-latest
    needs: [build_docker_image]
    steps:
      - name: Git Checkout
        uses: actions/checkout@v3
#      - name: Configure AWS credentials
#        uses: aws-actions/configure-aws-credentials@v1
#        with:
#          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#          aws-region: ap-southeast-1
      - name: Install AWS CLI
        id: install-aws-cli
        uses: unfor19/install-aws-cli-action@v1
        with:
          version: 2
      - uses: azure/setup-helm@v3
        with:
           version: 'v3.12.0'
      - name: Helm Apply
        run: |
          aws --version
          helm version
#          helm repo add sekolahlinux https://unbirabka.github.io/helm-sekolahlinux/charts
#          helm repo update
#          aws eks --region ${{env.AWS_DEFAULT_REGION}} update-kubeconfig --name ${{env.KUBECLUSTER}}
#          helm upgrade --version 0.1.0 ${{env.APP_NAME}}-${{env.ENVIRONMENT}} sekolahlinux/sekolahlinux --install --namespace ${{env.KUBENAMESPACE}} --values service-a/values.yaml 
            
